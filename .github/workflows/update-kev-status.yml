name: Update KEV Patch Status

on:
    # Run daily at 6 AM UTC
    schedule:
        - cron: '0 6 * * *'

    # Allow manual trigger
    workflow_dispatch:
        inputs:
            limit:
                description: 'Limit CVEs to check (for testing, leave empty for all)'
                required: false
                type: number

    # Run on push to main
    push:
        branches:
            - main
        paths:
            - 'src/**'
            - 'package.json'
            - '.github/workflows/update-kev-status.yml'
            - 'infra/**'

permissions:
    id-token: write

# Allow only one concurrent deployment
concurrency:
    group: 'deploy'
    cancel-in-progress: false

jobs:
    build:
        name: Build Site
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run KEV patch status checker
              env:
                  NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
              run: |
                  if [ -n "${{ inputs.limit }}" ]; then
                    npm run build -- --limit ${{ inputs.limit }}
                  else
                    npm run build
                  fi

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: site-build
                  path: docs/
                  retention-days: 1

    infra:
        name: Provision Infrastructure
        needs: build
        runs-on: ubuntu-latest
        outputs:
            cloudfront_distribution_id: ${{ steps.terraform_output.outputs.cloudfront_distribution_id }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: "1.6.0"
                  terraform_wrapper: false

            - name: Cache Terraform plugins
              uses: actions/cache@v4
              with:
                  path: ~/.terraform.d/plugin-cache
                  key: ${{ runner.os }}-terraform-${{ hashFiles('infra/**/*.tf') }}
                  restore-keys: |
                      ${{ runner.os }}-terraform-

            - name: Terraform Init
              working-directory: infra
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  AWS_REGION: ${{ secrets.AWS_REGION }}
              run: |
                  mkdir -p ~/.terraform.d/plugin-cache
                  terraform init \
                    -input=false \
                    -backend-config="bucket=gh-action-terraform-state" \
                    -backend-config="key=youmightwanna/terraform.tfstate" \
                    -backend-config="region=us-east-1" \
                    -backend-config="encrypt=true" \
                    -backend-config="dynamodb_table=terraform-state-lock"

            - name: Terraform Apply
              working-directory: infra
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  AWS_REGION: ${{ secrets.AWS_REGION }}
              run: |
                  terraform apply -auto-approve \
                    -var="bucket_name=${{ secrets.S3_BUCKET }}" \
                    -var="domain_name=${{ vars.DOMAIN }}" \
                    -var="route53_zone_id=${{ secrets.ROUTE53_ZONE_ID }}" \
                    -var="acm_certificate_arn=${{ secrets.ACM_CERT_ARN }}" \
                    -var="google_site_verification=${{ vars.GOOGLE_SITE_VERIFICATION }}"

            - name: Get Terraform Outputs
              id: terraform_output
              working-directory: infra
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  AWS_REGION: ${{ secrets.AWS_REGION }}
              run: |
                  CLOUDFRONT_ID=$(terraform output -raw cloudfront_distribution_id)
                  echo "cloudfront_distribution_id=$CLOUDFRONT_ID" >> $GITHUB_OUTPUT

    deploy:
        name: Deploy to S3/CloudFront
        needs: [build, infra]
        runs-on: ubuntu-latest

        environment:
            name: production
            url: https://${{ vars.DOMAIN }}

        steps:
            - name: Download build artifact
              uses: actions/download-artifact@v4
              with:
                  name: site-build
                  path: docs/

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Sync to S3
              run: |
                  aws s3 sync docs/ s3://${{ secrets.S3_BUCKET }} --delete

            - name: Invalidate CloudFront cache
              run: |
                  if [ -n "${{ needs.infra.outputs.cloudfront_distribution_id }}" ]; then
                    aws cloudfront create-invalidation \
                      --distribution-id "${{ needs.infra.outputs.cloudfront_distribution_id }}" \
                      --paths "/*"
                  else
                    echo "No CloudFront distribution ID available; skipping invalidation."
                  fi
