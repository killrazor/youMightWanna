name: Update KEV Patch Status

on:
    # Run daily at 6 AM UTC
    schedule:
        - cron: '0 6 * * *'

    # Allow manual trigger
    workflow_dispatch:
        inputs:
            limit:
                description: 'Limit CVEs to check (for testing, leave empty for all)'
                required: false
                type: number

    # Run on push to main (for initial setup)
    push:
        branches:
            - main
        paths:
            - 'check_patch_status.py'
            - '.github/workflows/update-kev-status.yml'
            - 'infra/**'
            - 'docs/**'

permissions:
    contents: write
    id-token: write

# Allow only one concurrent deployment
concurrency:
    group: 'deploy'
    cancel-in-progress: false

jobs:
    update:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.11'

            - name: Install dependencies
              run: pip install requests

            - name: Run KEV patch status checker
              env:
                  NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
              run: |
                  if [ -n "${{ inputs.limit }}" ]; then
                    python check_patch_status.py --limit ${{ inputs.limit }}
                  else
                    python check_patch_status.py
                  fi

            - name: Commit and push changes
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  git add docs/
                  git diff --staged --quiet || git commit -m "Update KEV patch status - $(date -u +'%Y-%m-%d %H:%M UTC')"
                  git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/killrazor/youMightWanna.git

    # Infrastructure provisioning with Terraform
    infra:
        name: Provision Infrastructure
        needs: update
        runs-on: ubuntu-latest
        outputs:
            cloudfront_distribution_id: ${{ steps.terraform_output.outputs.cloudfront_distribution_id }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: main

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: "1.6.0"
                  terraform_wrapper: false

            - name: Cache Terraform plugins
              uses: actions/cache@v4
              with:
                  path: ~/.terraform.d/plugin-cache
                  key: ${{ runner.os }}-terraform-${{ hashFiles('infra/**/*.tf') }}
                  restore-keys: |
                      ${{ runner.os }}-terraform-

            - name: Terraform Init
              working-directory: infra
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  AWS_REGION: ${{ secrets.AWS_REGION }}
              run: |
                  mkdir -p ~/.terraform.d/plugin-cache
                  terraform init \
                    -input=false \
                    -backend-config="bucket=gh-action-terraform-state" \
                    -backend-config="key=youmightwanna/terraform.tfstate" \
                    -backend-config="region=us-east-1" \
                    -backend-config="encrypt=true" \
                    -backend-config="dynamodb_table=terraform-state-lock"

            - name: Terraform Apply
              working-directory: infra
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  AWS_REGION: ${{ secrets.AWS_REGION }}
              run: |
                  terraform apply -auto-approve \
                    -var="bucket_name=${{ secrets.S3_BUCKET }}" \
                    -var="domain_name=${{ secrets.DOMAIN }}" \
                    -var="route53_zone_id=${{ secrets.ROUTE53_ZONE_ID }}" \
                    -var="acm_certificate_arn=${{ secrets.ACM_CERT_ARN }}"

            - name: Get Terraform Outputs
              id: terraform_output
              working-directory: infra
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  AWS_REGION: ${{ secrets.AWS_REGION }}
              run: |
                  CLOUDFRONT_ID=$(terraform output -raw cloudfront_distribution_id)
                  echo "cloudfront_distribution_id=$CLOUDFRONT_ID" >> $GITHUB_OUTPUT

    # Deploy static files to S3 and invalidate CloudFront
    deploy:
        name: Deploy to S3/CloudFront
        needs: infra
        runs-on: ubuntu-latest

        environment:
            name: production
            url: https://${{ secrets.DOMAIN }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: main

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Sync to S3
              run: |
                  aws s3 sync docs/ s3://${{ secrets.S3_BUCKET }} --delete

            - name: Invalidate CloudFront cache
              run: |
                  if [ -n "${{ needs.infra.outputs.cloudfront_distribution_id }}" ]; then
                    aws cloudfront create-invalidation \
                      --distribution-id "${{ needs.infra.outputs.cloudfront_distribution_id }}" \
                      --paths "/*"
                  else
                    echo "No CloudFront distribution ID available; skipping invalidation."
                  fi
